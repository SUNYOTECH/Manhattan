<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nebula回放客户端</title>
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/core.css" />
    <script type="text/javascript" src="./js/serverservice.js"></script>
</head>
<body>
<div id="wrapper" class="clearfix"> 
    <canvas id="ppt">
    </canvas>
    <div class="chat-container">
        <div class="online-list">
            <a href="javascipt:void(0);">
                <span class="online-title">
                    4人在线
                </span>
                <b class="arrow"></b>
            </a>
            <!--
            <a class="warn-msg" href="javascript:void(0);">
                <span class="warn-num">788</span>
                提醒
            </a>
            -->
        </div>
        <div class="message-container">
            <div class="s-msg">
                <a class="photo" href="">
                    <img src="./img/photo.jpg" alt="" />
                </a>
                <div class="txt-container">
                    <div class="txt">
                        雅，老师这节课讲得真TM好！
                    </div>
                    <b class="to"></b>
                </div>
            </div>
            <div class="s-msg right">
                <a class="photo" href="">
                    <img src="./img/photo.jpg" alt="" />
                </a>
                <div class="txt-container">
                    <div class="txt">
                        好
                    </div>
                    <b class="to"></b>
                </div>
            </div>
        </div>
        <div class="interaction">
            <input type="text" placeholder="在这里输入文字，进行聊天" name="msg" id="msg">
            <input type="button" value="发 送" id="send-btn" class="send">
        </div>
    </div>
</div>
    <script type="text/javascript">
        var idx = location.href.indexOf('?uid=');
        // 用户id
        var uid = (idx != -1) ? location.href.substring(idx + 5) : 0;
        //console.log(uid);
        var $ = function(selector) {
            return document.querySelector(selector);
        };

        var sendBtn = $("#send-btn"),
            txt = $("#msg"),
            container = $(".message-container"),
            value = "";

        sendBtn.onclick = function() {
            sendMsg(txt.value);
        }

        txt.onkeydown = function(e) {
            var keyCode = e.keyCode || e.which;

            if (keyCode == 13) {
                sendMsg(txt.value);
            }
        }

        function sendMsg(str) {
            //console.log(str);
            serverService.send('{"type":"CHAT","uid":"'+uid+'","value":"'+str+'"}');
            chatHandler(str);
        }

        function chatHandler(str) {
            var str = insertMsg(str);
            container.innerHTML += str;
            //container.appendChild("<p>" + str + "</p>");
            txt.value = "";
            txt.focus();
        }

        function insertMsg(str) {
            var str = '<div class="s-msg">' +
                        '<a class="photo" href="">' + 
                            '<img src="./img/photo.jpg" alt="" />' + 
                        '</a>' +
                        '<div class="txt-container">' +
                            '<div class="txt">' +
                                str +
                            '</div>' +
                            '<b class="to"></b>' +
                        '</div>' +
                       '</div>';

            return str;
        }

        // 链接服务器
        serverService.connect(connHandler, msgHandler, closeHandler);

        function connHandler() {
            serverService.send('{"type":"ONLI","uid":'+uid+'}');
            console.log("connected!");
        }

        function msgHandler(data) {
            //console.log("msg handler");
            console.log(data);
            var msg = JSON.parse(data) || {};

            if (msg.uid != uid)  {
                switch(msg.type) {
                    case "ONLI":
                        break;
                    case "OFFL":
                        break;
                    case "CHAT":
                        chatHandler(msg.value);
                        break;
                    default:
                        break;
                }
            }
        }

        function closeHandler() {
            console.log("close!");
        }
    </script>
</body>
</html>
