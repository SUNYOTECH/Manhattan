<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>多贝HTML5实时客户端</title>
    <link rel="stylesheet" href="./css/reset.css" />
    <link rel="stylesheet" href="./css/core.css" />
    <script type="text/javascript" src="./js/serverservice.js"></script>
</head>
<body>
<div id="wrapper" class="clearfix"> 
    <canvas id="ppt" width="640" height="480">
        该版本不支持您的浏览器，请及时更新到最新版本！
    </canvas>
    <div class="chat-container">
        <div class="online-list">
            <a href="javascipt:void(0);">
                <span class="online-title">
                    4人在线
                </span>
                <b class="arrow"></b>
            </a>
            <!--
            <a class="warn-msg" href="javascript:void(0);">
                <span class="warn-num">788</span>
                提醒
            </a>
            -->
        </div>
        <div class="message-container"></div>
        <div class="interaction">
            <input type="text" placeholder="在这里输入文字，进行聊天" name="msg" id="msg">
            <input type="button" value="发 送" id="send-btn" class="send">
        </div>
    </div>
</div>
    <script type="text/javascript">
        var idx = location.href.indexOf('?uid=');
        // 用户id
        var uid = (idx != -1) ? location.href.substring(idx + 5) : 0;
        //console.log(uid);
        var $ = function(selector) {
            return document.querySelector(selector);
        };

        var sendBtn = $("#send-btn"),
            txt = $("#msg"),
            container = $(".message-container"),
            value = "";

        sendBtn.onclick = function() {
            sendMsg(txt.value);
        }

        txt.onkeydown = function(e) {
            var keyCode = e.keyCode || e.which;

            if (keyCode == 13) {
                sendMsg(txt.value);
            }
        }

        function sendMsg(str) {
            //console.log(str);
            serverService.send("CHAT", uid, str);
            chatHandler(str);
        }

        function chatHandler(value) {
            var str = insertMsg(value);
            container.innerHTML += str;
            //container.appendChild("<p>" + str + "</p>");
            txt.value = "";
            txt.focus();
        }

        var canvas = document.getElementById("ppt"),
            context = canvas.getContext('2d'),
            isDrawing = false,
            canvasRect = canvas.getBoundingClientRect();

        canvas.onmousedown = function (e) {
            isDrawing = true;
            context.beginPath();
            context.strokeStyle = "red"; 
            context.lineWidth = 2;
            context.moveTo(e.pageX - canvasRect.left, e.pageY - canvasRect.top);
            serverService.send("DRMV", uid, '{"x":' + (e.pageX - canvasRect.left) + ', "y":' + (e.pageY - canvasRect.top) + '}');
            console.log("canvas down", e.pageX - canvasRect.left, e.pageY - canvasRect.top);
        }

        canvas.onmouseup = function (e) {
            isDrawing = false;
            context.closePath();
            console.log("canvas up", e.pageX - canvasRect.left, e.pageY - canvasRect.top);			
        }

        canvas.onmousemove = function (e) {
            if (isDrawing) {
                context.lineTo(e.pageX - canvasRect.left, e.pageY - canvasRect.top);
                context.stroke();
                serverService.send("DRLI", uid, '{"x":' + (e.pageX - canvasRect.left) + ', "y":' + (e.pageY - canvasRect.top) + '}');
                console.log("canvas move", e.pageX - canvasRect.left, e.pageY - canvasRect.top);
            }
        }

        function drawLineHandler(x, y) {
            context.lineTo(x, y);
            context.stroke();
            console.log("draw line handler", x, y);
        }

        function drawMoveHandler(x, y) {
            context.beginPath();
            context.strokeStyle = "red"; 
            context.lineWidth = 2;
            context.moveTo(x, y); 
            console.log("draw move handler", x, y);
        }

        function drawCleanHandler() {
            context.clearRect(0, 0, canvas.width, canvas.height);
        }

        function insertMsg(str) {
            var str = '<div class="s-msg">' +
                        '<a class="photo" href="">' + 
                            '<img src="./img/photo.jpg" alt="" />' + 
                        '</a>' +
                        '<div class="txt-container">' +
                            '<div class="txt">' +
                                str +
                            '</div>' +
                            '<b class="to"></b>' +
                        '</div>' +
                       '</div>';

            return str;
        }

        // 链接服务器
        serverService.connect(connHandler, msgHandler, closeHandler);

        function connHandler() {
            serverService.send("ONLI", uid);
            console.log("connected!");
        }

        function msgHandler(data) {
            //console.log("msg handler");
            console.log(data);
            var msg = JSON.parse(data) || {};

            if (msg.uid != uid)  {
                switch(msg.type) {
                    case "ONLI":
                        break;
                    case "OFFL":
                        break;
                    case "CHAT":
                        chatHandler(msg.value);
                        break;
                    case "DRLI":
                        drawLineHandler(msg.value.x, msg.value.y);
                        break;
                    case "DRMV":
                        drawMoveHandler(msg.value.x, msg.value.y);
                        break;
                    case "DRCL":
                        drawCleanHandler();
                        break;
                    default:
                        break;
                }
            }
        }

        function closeHandler() {
            console.log("close!");
        }
    </script>
</body>
</html>
